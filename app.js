const products=[{id:'p1',name:'Coxinha',price:6.5},{id:'p2',name:'Pastel',price:8.0},{id:'p3',name:'Refrigerante',price:5.0}];
const productListEl=document.getElementById('productList');const cartItemsEl=document.getElementById('cartItems');const totalEl=document.getElementById('total');const orderForm=document.getElementById('orderForm');const mensagemEl=document.getElementById('mensagem');const clearCartBtn=document.getElementById('clearCartBtn');let cart={};
function formatCurrency(v){return v.toFixed(2);}function renderProducts(){productListEl.innerHTML='';products.forEach(p=>{const div=document.createElement('div');div.className='product';div.innerHTML=`<div><strong>${p.name}</strong><div class='muted'>R$ ${formatCurrency(p.price)}</div></div><div class='controls'><span class='qty-controls'><button data-action='decrease' data-id='${p.id}'>-</button><span id='qty-${p.id}'>0</span><button data-action='increase' data-id='${p.id}'>+</button></span><button class='btn' data-action='add' data-id='${p.id}'>Adicionar</button></div>`;productListEl.appendChild(div);});}
function updateQtyDisplay(id){const qtySpan=document.getElementById(`qty-${id}`);qtySpan.textContent=cart[id]?cart[id].qty:0;}
function renderCart(){cartItemsEl.innerHTML='';let total=0;Object.values(cart).forEach(item=>{const li=document.createElement('li');li.innerHTML=`<span>${item.name} x ${item.qty}</span><span>R$ ${formatCurrency(item.qty*item.price)}</span>`;cartItemsEl.appendChild(li);total+=item.qty*item.price;});totalEl.textContent=formatCurrency(total);}
productListEl.addEventListener('click',e=>{const btn=e.target.closest('button');if(!btn)return;const id=btn.dataset.id;const action=btn.dataset.action;if(action==='increase'||action==='decrease'){let currentQty=cart[id]?cart[id].qty:0;if(action==='increase')currentQty++;else currentQty=Math.max(0,currentQty-1);if(currentQty===0){if(!cart[id]){document.getElementById(`qty-${id}`).textContent=0;return;}else{cart[id].qty=0;}}else{const prod=products.find(p=>p.id===id);cart[id]={...prod,qty:currentQty};}updateQtyDisplay(id);}else if(action==='add'){const prod=products.find(p=>p.id===id);const qty=cart[id]?cart[id].qty:1;if(qty<=0){mensagemEl.textContent='Escolha pelo menos 1 item antes de adicionar.';setTimeout(()=>mensagemEl.textContent='',2500);return;}if(cart[id]&&cart[id].added){cart[id].qty+=qty;}else{cart[id]={...prod,qty,added:true};}updateQtyDisplay(id);renderCart();}});
clearCartBtn.addEventListener('click',()=>{cart={};products.forEach(p=>document.getElementById(`qty-${p.id}`).textContent=0);renderCart();});
orderForm.addEventListener('submit',async e=>{e.preventDefault();mensagemEl.textContent='';const nome=document.getElementById('nome').value.trim();const telefone=document.getElementById('telefone').value.trim();const endereco=document.getElementById('endereco').value.trim();const itemsArray=Object.values(cart).filter(i=>i.qty>0).map(i=>`${i.name} x ${i.qty}`);if(itemsArray.length===0){mensagemEl.textContent='Carrinho vazio. Adicione items antes de enviar.';return;}const total=Object.values(cart).reduce((s,i)=>s+(i.qty*i.price),0);const payload={nome,telefone,endereco,items:itemsArray.join(', '),total:`R$ ${formatCurrency(total)}`};try{const res=await fetch('/.netlify/functions/enviarParaNotion',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});const data=await res.json();if(res.ok){mensagemEl.textContent='✅ Pedido enviado com sucesso!';cart={};products.forEach(p=>document.getElementById(`qty-${p.id}`).textContent=0);orderForm.reset();renderCart();}else{mensagemEl.textContent=`❌ Erro: ${data.error||'Erro desconhecido'}`;}}catch(err){console.error(err);mensagemEl.textContent='❌ Erro de conexão com o servidor.';}});
renderProducts();renderCart();